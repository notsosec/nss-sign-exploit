package signexploit;

import net.minecraft.client.Minecraft;
import net.minecraft.client.network.NetHandlerPlayClient;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.network.play.client.C12PacketUpdateSign;
import net.minecraft.util.BlockPos;
import net.minecraft.util.ChatComponentText;
import net.minecraft.util.IChatComponent;
import net.minecraft.world.World;
import net.minecraftforge.event.entity.player.PlayerInteractEvent;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;

public class SignEvent {

    private static boolean isInAction = false;

    /**
     * Gets called whenever the client interacts with his/her mouse.
     *
     * @param event An instance of the event.
     */
    @SubscribeEvent
    public void interact(PlayerInteractEvent event) {
        final EntityPlayer player               = event.entityPlayer;
        final PlayerInteractEvent.Action action = event.action;
        final PlayerInteractEvent eventCopy     = event;

        if (action == PlayerInteractEvent.Action.RIGHT_CLICK_BLOCK) {
            if (event.entityPlayer.getHeldItem() != null) {
                if (event.entityPlayer.getHeldItem().getDisplayName().toLowerCase().equals("sign")) {
                    if (SignExploit.isEnabled) {

                        if (isInAction) return;
                        final NetHandlerPlayClient packetBus = Minecraft.getMinecraft().getNetHandler();

                        isInAction = true;
                        Thread thread = new Thread(new Runnable() {
                            @Override
                            public void run() {
                                try {
                                    Thread.sleep(500);
                                    isInAction = false;

                                    IChatComponent[] components = new IChatComponent[4];
                                    BlockPos nearbyPos = searchForRelativeSign(eventCopy.world, eventCopy.pos);

                                    components[0] = new ChatComponentText("Crazy letter goes here");
                                    components[1] = new ChatComponentText("Crazy letter goes here");
                                    components[2] = new ChatComponentText("Crazy letter goes here");
                                    components[3] = new ChatComponentText("Crazy letter goes here");

                                    if (nearbyPos == null) {
                                        player.getCommandSenderEntity().addChatMessage(new ChatComponentText("Error processing sign!"));
                                        return;
                                    }

                                    Minecraft.getMinecraft().getNetHandler().getNetworkManager().sendPacket(new C12PacketUpdateSign(nearbyPos, components));
                                    Minecraft.getMinecraft().displayGuiScreen(null);

                                    player.getCommandSenderEntity().addChatMessage(new ChatComponentText("Executed sign-exploit!"));
                                    Thread.sleep(500);
                                } catch (InterruptedException e) {
                                    e.printStackTrace();
                                }
                            }
                        });
                        thread.start();
                    }
                }
            }
        }
    }

    /**
     * Iterates through all of a block sides and checks if it is a sign.
     * @param world The world that the block is in.
     * @param pos The position that the block is in.
     * @return The BlockPos of the found sign, otherwise null.
     */
    private BlockPos searchForRelativeSign(final World world, final BlockPos pos) {
        for (int x = pos.getX() - 1; x < pos.getX() + 1; x++) {
            for (int y = pos.getY() - 1; y < pos.getY() + 1; y++) {
                for (int z = pos.getZ() - 1; z < pos.getZ() + 1; z++) {
                    BlockPos comparePos = new BlockPos(x, y, z);

                    if (world.getChunkFromBlockCoords(comparePos).getBlock(comparePos).getUnlocalizedName().toLowerCase().contains("sign")) return comparePos;
                }
            }
        }
        return null;
    }
}
